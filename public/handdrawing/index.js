(()=>{"use strict";function t(t,r){return e(t,r)||void 0===r||(r.max&&(t=Math.min(r.max,t)),r.min&&(t=Math.max(r.min,t))),t}function e(t,e){return void 0===e||!(t<=0||void 0!==e&&(void 0!==e.max&&e.max<t||void 0!==e.min&&e.min>t))}class r{static addVector(t,e){return null==t.z&&null==e.z?{x:t.x+e.x,y:t.y+e.y}:(null!=t.z&&null!=e.z||(null==t.z&&(t.z=0),null==e.z&&(e.z=0)),{x:t.x+e.x,y:t.y+e.y,z:t.z+e.z})}static subVector(t,e){return null==t.z&&null==e.z?{x:t.x-e.x,y:t.y-e.y}:(null!=t.z&&null!=e.z||(null==t.z&&(t.z=0),null==e.z&&(e.z=0)),{x:t.x-e.x,y:t.y-e.y,z:t.z-e.z})}static multiplyVectorByScalar(t,e){return null==t.z?{x:t.x*e,y:t.y*e}:{x:t.x*e,y:t.y*e,z:t.z*e}}static divideVectorByScalar(t,e){return 0==e?{x:t.x,y:t.y}:null==t.z?{x:t.x/e,y:t.y/e}:{x:t.x/e,y:t.y/e,z:t.z/e}}static magnitude(t){return null==t.z&&(t.z=0),Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}static unitVector(t){return null==t.z&&(t.z=0),0!=this.magnitude(t)?{x:t.x/this.magnitude(t),y:t.y/this.magnitude(t),z:t.z/this.magnitude(t)}:{x:0,y:0,z:0}}static dotProduct(t,e){return null==t.z&&null==e.z?t.x*e.x+t.y*e.y:(null!=t.z&&null!=e.z||(null==t.z&&(t.z=0),null==e.z&&(e.z=0)),t.x*e.x+t.y*e.y+t.z*e.z)}static crossProduct(t,e){return null!=t.z&&null!=e.z||(null==t.z&&(t.z=0),null==e.z&&(e.z=0)),{x:t.y*e.z-t.z*e.y,y:t.z*e.x-t.x*e.z,z:t.x*e.y-t.y*e.x}}static unitVectorFromA2B(t,e){return this.unitVector(this.subVector(e,t))}static rotatePoint(t,e){return{x:t.x*Math.cos(e)-t.y*Math.sin(e),y:t.x*Math.sin(e)+t.y*Math.cos(e)}}static transform2NewAxis(t,e){return{x:t.x*Math.cos(e)+t.y*Math.sin(e),y:-t.x*Math.sin(e)+t.y*Math.cos(e)}}static angleFromA2B(t,e){return Math.atan2(t.x*e.y-t.y*e.x,t.x*e.x+t.y*e.y)}static transformPointWRTAnchor(t,e,r){let i=this.rotatePoint(this.subVector(t,e),r);return this.addVector(i,e)}static distanceBetweenPoints(t,e){return this.magnitude(this.subVector(t,e))}static flipYAxis(t){return{x:t.x,y:-t.y,z:t.z}}static linearInterpolation(t,e,r){return null==t.z||null==e.z?{x:t.x+(e.x-t.x)*r,y:t.y+(e.y-t.y)*r}:{x:t.x+(e.x-t.x)*r,y:t.y+(e.y-t.y)*r,z:t.z+(e.z-t.z)*r}}static isEqual(t,e){return null==t.z&&(t.z=0),null==e.z&&(e.z=0),t.x==e.x&&t.y==e.y&&t.z==e.z}static getLineIntersection(t,e,i,a){const o=(a.x-i.x)*(t.y-i.y)-(a.y-i.y)*(t.x-i.x),s=(a.y-i.y)*(e.x-t.x)-(a.x-i.x)*(e.y-t.y);if(0===s)return{intersects:!1};const n=o/s;return n>=0&&n<=1?{intersects:!0,intersection:r.linearInterpolation(t,e,n),offset:n}:{intersects:!1}}}function i(t,e,i,a,o,s){let n={x:i/2,y:a/2},l=r.subVector(e,n);return l=r.multiplyVectorByScalar(l,1/o),l=r.rotatePoint(l,s),r.addVector(t,l)}function a(t,e,i,a,o,s){let n={x:e/2,y:i/2},l=r.subVector(t,n);return l=r.multiplyVectorByScalar(l,1/o),l=r.rotatePoint(l,s),r.addVector(a,l)}function o(t,e){if(null==e)return!0;let r=!1,i=!1,a=!1,o=!1;return(null==e.max||null==e.max.x||t.x<=e.max.x)&&(i=!0),(null==e.min||null==e.min.x||t.x>=e.min.x)&&(r=!0),(null==e.max||null==e.max.y||t.y<=e.max.y)&&(a=!0),(null==e.min||null==e.min.y||t.y>=e.min.y)&&(o=!0),r&&i&&a&&o}function s(t,e){if(o(t,e)||null==e)return t;let r={x:t.x,y:t.y},i=e.min;return null!=i&&(null!=i.x&&(r.x=Math.max(r.x,i.x)),null!=i.y&&(r.y=Math.max(r.y,i.y))),i=e.max,null!=i&&(null!=i.x&&(r.x=Math.min(r.x,i.x)),null!=i.y&&(r.y=Math.min(r.y,i.y))),r}function n(t){if(null!=t&&null!=t.min&&null!=t.max&&null!=t.min.x&&null!=t.max.x)return t.max.x-t.min.x}function l(t){if(null!=t&&null!=t.min&&null!=t.max&&null!=t.min.y&&null!=t.max.y)return t.max.y-t.min.y}function h(t,e,a,o,n,l){if(null==o)return t;let h=i(t,{x:0,y:a},e,a,n,l),c=i(t,{x:0,y:0},e,a,n,l),d=i(t,{x:e,y:a},e,a,n,l),u=i(t,{x:e,y:0},e,a,n,l),m=s(h,o),b=s(d,o),v=s(c,o),_=s(u,o),y=[r.subVector(m,h),r.subVector(b,d),r.subVector(v,c),r.subVector(_,u)],g=Math.abs(y[0].x),p=Math.abs(y[0].y),x=y[0];return y.forEach((t=>{Math.abs(t.x)>g&&(g=Math.abs(t.x),x.x=t.x),Math.abs(t.y)>p&&(p=Math.abs(t.y),x.y=t.y)})),r.addVector(t,x)}function c(t,e){if(d(t,e)||void 0===e)return t;t=u(t);const r=m(e.start,t),i=m(e.end,t);return e.ccw&&(r<0||i>0)||!e.ccw&&(r>0||i<0)?Math.abs(r)===Math.abs(i)?e.startAsTieBreaker?e.start:e.end:Math.abs(r)<Math.abs(i)?e.start:e.end:t}function d(t,e){if(void 0===e)return!0;const r=m(e.start,t),i=m(e.end,t);return!(e.ccw&&(r<0||i>0)||!e.ccw&&(r>0||i<0))}function u(t){return((t%=2*Math.PI)+2*Math.PI)%(2*Math.PI)}function m(t,e){t=u(t);let r=(e=u(e))-t;return r>Math.PI&&(r=-(2*Math.PI-r)),r<-Math.PI&&(r+=2*Math.PI),r}class b{constructor(t=void 0){this._nextHandler=t}set nextHandler(t){this._nextHandler=t}get nextHandler(){return this._nextHandler}chainHandler(t){return this._nextHandler=t,t}panCameraTo(t,e){this._nextHandler&&this._nextHandler.panCameraTo(t,e)}panCameraBy(t,e){this._nextHandler&&this._nextHandler.panCameraBy(t,e)}}class v extends b{constructor(t=void 0){super(t)}panCameraTo(t,e){t.setPosition(e)}panCameraBy(t,e){t.setPosition(r.addVector(t.position,e))}}class _ extends b{constructor(t=void 0){super(t),this._entireViewPort=!1}set entireViewPort(t){this._entireViewPort=t}get entireViewPort(){return this._entireViewPort}panCameraTo(t,e){let r=s(e,t.boundaries);this._entireViewPort&&(r=h(e,t.viewPortWidth,t.viewPortHeight,t.boundaries,t.zoomLevel,t.rotation)),super.panCameraTo(t,r)}panCameraBy(t,e){let i=r.subVector(s(r.addVector(t.position,e),t.boundaries),t.position);this._entireViewPort&&(i=r.subVector(h(r.addVector(t.position,e),t.viewPortWidth,t.viewPortHeight,t.boundaries,t.zoomLevel,t.rotation),t.position)),super.panCameraBy(t,i)}}class y extends b{constructor(t=void 0){super(t),this._restrictXTranslation=!1,this._restrictYTranslation=!1,this._restrictRelativeXTranslation=!1,this._restrictRelativeYTranslation=!1}set restrictXTranslation(t){this._restrictXTranslation=t}get restrictXTranslation(){return this._restrictXTranslation}set restrictYTranslation(t){this._restrictYTranslation=t}get restrictYTranslation(){return this._restrictYTranslation}set restrictRelativeXTranslation(t){this._restrictRelativeXTranslation=t}get restrictRelativeXTranslation(){return this._restrictRelativeXTranslation}set restrictRelativeYTranslation(t){this._restrictRelativeYTranslation=t}get restrictRelativeYTranslation(){return this._restrictRelativeYTranslation}convertDeltaToComplyWithRestriction(t,e){if(this._restrictXTranslation&&this._restrictYTranslation)return{x:0,y:0};if(this._restrictRelativeXTranslation&&this._restrictRelativeYTranslation)return{x:0,y:0};if(this._restrictXTranslation&&(e.x=0),this._restrictYTranslation&&(e.y=0),this._restrictRelativeXTranslation){const i=r.rotatePoint({x:0,y:1},t.rotation),a=r.dotProduct(i,e);e=r.multiplyVectorByScalar(i,a)}if(this._restrictRelativeYTranslation){const i=r.rotatePoint({x:1,y:0},t.rotation),a=r.dotProduct(i,e);e=r.multiplyVectorByScalar(i,a)}return e}panCameraTo(t,e){let i=r.subVector(e,t.position);if(i=this.convertDeltaToComplyWithRestriction(t,i),0===i.x&&0===i.y)return;const a=r.addVector(t.position,i);super.panCameraTo(t,a)}panCameraBy(t,e){e=this.convertDeltaToComplyWithRestriction(t,e),super.panCameraBy(t,e)}}class g extends b{set restrictRelativeXTranslation(t){this.restrictionHandler.restrictRelativeXTranslation=t}set restrictRelativeYTranslation(t){this.restrictionHandler.restrictRelativeYTranslation=t}set restrictXTranslation(t){this.restrictionHandler.restrictXTranslation=t}set restrictYTranslation(t){this.restrictionHandler.restrictYTranslation=t}set restrictTranslation(t){this.restrictionHandler.restrictXTranslation=t,this.restrictionHandler.restrictYTranslation=t}get restrictTranslation(){return this.restrictionHandler.restrictXTranslation}get restrictXTranslation(){return this.restrictionHandler.restrictXTranslation}get restrictYTranslation(){return this.restrictionHandler.restrictYTranslation}get restrictRelativeXTranslation(){return this.restrictionHandler.restrictRelativeXTranslation}get restrictRelativeYTranslation(){return this.restrictionHandler.restrictRelativeYTranslation}set limitEntireViewPort(t){this.clampHandler.entireViewPort=t}get limitEntireViewPort(){return this.clampHandler.entireViewPort}constructor(){super(),this.baseHandler=new v,this.clampHandler=new _,this.restrictionHandler=new y,this.restrictionHandler.chainHandler(this.clampHandler).chainHandler(this.baseHandler),this.nextHandler=this.restrictionHandler}}class p{constructor(t=void 0){this._nextHandler=t}set nextHandler(t){this._nextHandler=t}get nextHandler(){return this._nextHandler}chainHandler(t){return this._nextHandler=t,t}rotateCameraTo(t,e){this._nextHandler&&this._nextHandler.rotateCameraTo(t,e)}rotateCameraBy(t,e){this._nextHandler&&this._nextHandler.rotateCameraBy(t,e)}}class x extends p{constructor(t=void 0){super()}rotateCameraTo(t,e){e=u(e),t.setRotation(e)}rotateCameraBy(t,e){const r=t.rotation,i=u(r+e);e=m(r,i),t.setRotation(i)}}class C extends p{constructor(t=void 0){super(t),this._restrictRotation=!1}get restrictRotation(){return this._restrictRotation}set restrictRotation(t){this._restrictRotation=t}rotateCameraBy(t,e){this._restrictRotation||super.rotateCameraBy(t,e)}rotateCameraTo(t,e){this._restrictRotation||super.rotateCameraTo(t,e)}}class z extends p{constructor(t=void 0){super(t)}rotateCameraBy(t,e){const r=t.rotation;let i=u(r+e);i=c(i,t.rotationBoundaries),e=m(r,i),super.rotateCameraBy(t,e)}rotateCameraTo(t,e){e=c(e=u(e),t.rotationBoundaries),super.rotateCameraTo(t,e)}}class H extends p{get restrictRotation(){return this._restrictionHandler.restrictRotation}set restrictRotation(t){this._restrictionHandler.restrictRotation=t}constructor(t=void 0){super(t),this._baseHandler=new x,this._clampHandler=new z(this._baseHandler),this._restrictionHandler=new C(this._clampHandler)}rotateCameraBy(t,e){this._restrictionHandler.rotateCameraBy(t,e),super.rotateCameraBy(t,e)}rotateCameraTo(t,e){this._restrictionHandler.rotateCameraTo(t,e),super.rotateCameraTo(t,e)}}class S{constructor(t=void 0){this._nextHandler=t}set nextHandler(t){this._nextHandler=t}get nextHandler(){return this._nextHandler}chainHandler(t){return this._nextHandler=t,t}zoomCameraTo(t,e){this._nextHandler&&this._nextHandler.zoomCameraTo(t,e)}zoomCameraBy(t,e){this._nextHandler&&this._nextHandler.zoomCameraBy(t,e)}zoomCameraToAt(t,e,r){this._nextHandler&&this._nextHandler.zoomCameraToAt(t,e,r)}zoomCameraByAt(t,e,r){this._nextHandler&&this._nextHandler.zoomCameraByAt(t,e,r)}}class w extends S{constructor(t,e=void 0){super(e),this.panHandler=t}set nextHandler(t){this._nextHandler=void 0}zoomCameraTo(t,e){t.setZoomLevel(e)}zoomCameraBy(t,e){const r=t.zoomLevel+e;t.setZoomLevel(r)}zoomCameraToAt(t,e,i){let o=a(i,t.viewPortWidth,t.viewPortHeight,t.position,t.zoomLevel,t.rotation);t.zoomLevel,t.setZoomLevel(e);let s=a(i,t.viewPortWidth,t.viewPortHeight,t.position,t.zoomLevel,t.rotation);const n=r.subVector(o,s);this.panHandler.panCameraBy(t,n)}zoomCameraByAt(t,e,i){let o=a(i,t.viewPortWidth,t.viewPortHeight,t.position,t.zoomLevel,t.rotation);const s=t.zoomLevel+e;t.setZoomLevel(s);let n=a(i,t.viewPortWidth,t.viewPortHeight,t.position,t.zoomLevel,t.rotation);const l=r.subVector(o,n);this.panHandler.panCameraBy(t,l)}}class f extends S{constructor(t=void 0){super(t)}zoomCameraTo(e,r){r=t(r,e.zoomBoundaries),super.zoomCameraTo(e,r)}zoomCameraBy(e,r){let i=e.zoomLevel+r;i=t(i,e.zoomBoundaries),r=i-e.zoomLevel,super.zoomCameraBy(e,r)}zoomCameraToAt(e,r,i){r=t(r,e.zoomBoundaries),super.zoomCameraToAt(e,r,i)}zoomByAt(e,r,i){let a=e.zoomLevel+r;a=t(a,e.zoomBoundaries),r=a-e.zoomLevel,super.zoomCameraByAt(e,r,i)}}class P extends S{constructor(t=void 0){super(t),this._restrictZoom=!1}set restrictZoom(t){this._restrictZoom=t}get restrictZoom(){return this._restrictZoom}zoomCameraTo(t,e){this._restrictZoom||super.zoomCameraTo(t,e)}zoomCameraBy(t,e){this._restrictZoom||super.zoomCameraBy(t,e)}zoomCameraToAt(t,e,r){this._restrictZoom||super.zoomCameraToAt(t,e,r)}zoomCameraByAt(t,e,r){this._restrictZoom||super.zoomCameraByAt(t,e,r)}}class T extends S{constructor(t,e=void 0){super(e),this._baseHandler=new w(t),this._clampHandler=new f,this._restrictionHandler=new P,this._restrictionHandler.chainHandler(this._clampHandler).chainHandler(this._baseHandler),this._nextHandler=this._restrictionHandler}set restrictZoom(t){this._restrictionHandler.restrictZoom=t}get restrictZoom(){return this._restrictionHandler.restrictZoom}zoomCameraTo(t,e){super.zoomCameraTo(t,e)}zoomCameraBy(t,e){super.zoomCameraBy(t,e)}zoomCameraByAt(t,e,r){super.zoomCameraByAt(t,e,r)}zoomCameraToAt(t,e,r){super.zoomCameraToAt(t,e,r)}}function B(t,e,r,i){return new(r||(r=Promise))((function(a,o){function s(t){try{l(i.next(t))}catch(t){o(t)}}function n(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?a(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,n)}l((i=i.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class L{constructor(){this.panCallbackList=[],this.zoomCallbackList=[],this.rotateCallbackList=[]}notifyPositionChange(t,e){return B(this,void 0,void 0,(function*(){queueMicrotask((()=>{this.panCallbackList.forEach((r=>{r({diff:t},e)}))}))}))}notifyZoomChange(t,e){return B(this,void 0,void 0,(function*(){return new Promise(((r,i)=>{this.zoomCallbackList.forEach((r=>{r({deltaZoomAmount:t},e)})),r()}))}))}notifyRotationChange(t,e){return B(this,void 0,void 0,(function*(){return new Promise(((r,i)=>{this.rotateCallbackList.forEach((r=>{r({deltaRotation:t},e)})),r()}))}))}on(t,e){switch(t){case"pan":return this.panCallbackList.push(e),()=>{this.panCallbackList=this.panCallbackList.filter((t=>t!==e))};case"zoom":return this.zoomCallbackList.push(e),()=>{this.zoomCallbackList=this.zoomCallbackList.filter((t=>t!==e))};case"rotate":return this.rotateCallbackList.push(e),()=>{this.rotateCallbackList=this.rotateCallbackList.filter((t=>t!==e))}}return()=>{}}clearCallbacks(){this.panCallbackList=[],this.zoomCallbackList=[],this.rotateCallbackList=[]}}class O{constructor(t=new L,e={x:0,y:0},r=1e3,i=1e3,a=1,o=0){this._position=e,this._zoomLevel=a,this._rotation=o,this._viewPortHeight=i,this._viewPortWidth=r,this._observer=t}get boundaries(){return this._boundaries}set boundaries(t){this._boundaries=t}get viewPortWidth(){return this._viewPortWidth}set viewPortWidth(t){this._viewPortWidth=t}get viewPortHeight(){return this._viewPortHeight}set viewPortHeight(t){this._viewPortHeight=t}get position(){return this._position}get observer(){return this._observer}setPosition(t){if(o(t,this._boundaries)){const e=r.subVector(t,this._position);if(r.magnitude(e)<1e-9&&r.magnitude(e)<1/this._zoomLevel)return;this._position=t,this._observer.notifyPositionChange(e,{position:this._position,rotation:this._rotation,zoomLevel:this._zoomLevel})}}get zoomLevel(){return this._zoomLevel}get zoomBoundaries(){return this._zoomBoundaries}set zoomBoundaries(t){if(void 0!==t&&void 0!==t.min&&void 0!==t.max&&t.min>t.max){let e=t.max;t.max=t.min,t.min=e}this._zoomBoundaries=t}setMaxZoomLevel(t){return null==this._zoomBoundaries&&(this._zoomBoundaries={min:void 0,max:void 0}),!(null!=this._zoomBoundaries.min&&this._zoomBoundaries.min>t||this._zoomLevel>t||(this._zoomBoundaries.max=t,0))}setMinZoomLevel(t){return null==this._zoomBoundaries&&(this._zoomBoundaries={min:void 0,max:void 0}),!(null!=this._zoomBoundaries.max&&this._zoomBoundaries.max<t||(this._zoomBoundaries.min=t,this._zoomLevel<t&&(this._zoomLevel=t),0))}setZoomLevel(r){if(e(r,this._zoomBoundaries)){if(void 0!==this._zoomBoundaries&&void 0!==this._zoomBoundaries.max&&t(r,this._zoomBoundaries)==this._zoomBoundaries.max&&this._zoomLevel==this._zoomBoundaries.max)return;if(void 0!==this._zoomBoundaries&&void 0!==this._zoomBoundaries.min&&t(r,this._zoomBoundaries)==this._zoomBoundaries.min&&this._zoomLevel==this._zoomBoundaries.min)return;const e=this._zoomLevel;this._zoomLevel=r,this._observer.notifyZoomChange(this._zoomLevel-e,{position:this._position,rotation:this._rotation,zoomLevel:this._zoomLevel})}}get rotation(){return this._rotation}get rotationBoundaries(){return this._rotationBoundaries}set rotationBoundaries(t){if(void 0!==t&&void 0!==t.start&&void 0!==t.end&&t.start>t.end){let e=t.end;t.end=t.start,t.start=e}this._rotationBoundaries=t}setRotation(t){if(d(t,this._rotationBoundaries)){if(t=u(t),void 0!==this._rotationBoundaries&&void 0!==this._rotationBoundaries.end&&c(t,this._rotationBoundaries)==this._rotationBoundaries.end&&this._rotation==this._rotationBoundaries.end)return;if(void 0!==this._rotationBoundaries&&void 0!==this.rotationBoundaries.start&&c(t,this._rotationBoundaries)==this._rotationBoundaries.start&&this._rotation==this._rotationBoundaries.start)return;this._observer.notifyRotationChange(t-this._rotation,{position:this._position,rotation:t,zoomLevel:this._zoomLevel}),this._rotation=t}}convertFromViewPort2WorldSpace(t){return a(t,this._viewPortWidth,this._viewPortHeight,this._position,this._zoomLevel,this._rotation)}invertFromWorldSpace2ViewPort(t){let e={x:this.viewPortWidth/2,y:this._viewPortHeight/2},i=r.subVector(t,this._position);return i=r.rotatePoint(i,-this._rotation),i=r.multiplyVectorByScalar(i,this._zoomLevel),r.addVector(e,i)}setHorizontalBoundaries(t,e){if(t>e){let r=e;e=t,t=r}null==this._boundaries&&(this._boundaries={min:{x:void 0,y:void 0},max:{x:void 0,y:void 0}}),this._boundaries.min.x=t,this._boundaries.max.x=e}setVerticalBoundaries(t,e){if(t>e){let r=e;e=t,t=r}null==this._boundaries&&(this._boundaries={min:{x:void 0,y:void 0},max:{x:void 0,y:void 0}}),this._boundaries.min.y=t,this._boundaries.max.y=e}on(t,e){return this._observer.on(t,e)}}class k{constructor(t,e,r,i=!1,a=!0){this._panDisabled=!1,this._zoomDisabled=!1,this._rotateDisabled=!1,this._keyController=new Map,this.SCROLL_SENSATIVITY=.005,this.isDragging=!1,this._canvas=t,this._camera=e,this._debugMode=i,this._alignCoordinateSystem=a,this.bindFunctions(),this.inputObserver=r}get debugMode(){return this._debugMode}set debugMode(t){this._debugMode=t}get alignCoordinateSystem(){return this._alignCoordinateSystem}set alignCoordinateSystem(t){this._alignCoordinateSystem=t}get panDisabled(){return this._panDisabled}set panDisabled(t){this._panDisabled=t,t&&(this.canvas.style.cursor="auto",this.isDragging=!1,this.dragStartPoint={x:0,y:0})}get zoomDisabled(){return this._zoomDisabled}set zoomDisabled(t){this._zoomDisabled=t}get rotateDisabled(){return this._rotateDisabled}set rotateDisabled(t){this._rotateDisabled=t}get camera(){return this._camera}set camera(t){this._camera=t}get canvas(){return this._canvas}setUp(){this.canvas.addEventListener("pointerdown",this.pointerDownHandler),this.canvas.addEventListener("pointerup",this.pointerUpHandler),this.canvas.addEventListener("pointermove",this.pointerMoveHandler),this.canvas.addEventListener("wheel",this.scrollHandler),window.addEventListener("keydown",this.keypressHandler),window.addEventListener("keyup",this.keyupHandler),this.setupKeyController([" "])}tearDown(){this.canvas.removeEventListener("pointerdown",this.pointerDownHandler),this.canvas.removeEventListener("pointerup",this.pointerUpHandler),this.canvas.removeEventListener("pointermove",this.pointerMoveHandler),this.canvas.removeEventListener("wheel",this.scrollHandler),window.removeEventListener("keydown",this.keypressHandler),window.removeEventListener("keyup",this.keyupHandler)}bindFunctions(){this.pointerDownHandler=this.pointerDownHandler.bind(this),this.pointerUpHandler=this.pointerUpHandler.bind(this),this.pointerMoveHandler=this.pointerMoveHandler.bind(this),this.scrollHandler=this.scrollHandler.bind(this),this.keypressHandler=this.keypressHandler.bind(this),this.keyupHandler=this.keyupHandler.bind(this)}setupKeyController(t){t.forEach((t=>{this._keyController.set(t,!1)}))}pointerDownHandler(t){this._disabled||"mouse"!==t.pointerType||1!=t.button&&!t.metaKey&&!this._keyController.get(" ")||this._panDisabled||(this.isDragging=!0,this.dragStartPoint={x:t.clientX,y:t.clientY})}disableStrategy(){this.isDragging=!1,this.dragStartPoint={x:0,y:0},this._disabled=!0}enableStrategy(){this._disabled=!1}pointerUpHandler(t){this._disabled||"mouse"===t.pointerType&&(this.isDragging&&(this.isDragging=!1),this._debugMode?this.canvas.style.cursor="none":this.canvas.style.cursor="auto")}pointerMoveHandler(t){if(!this._disabled&&"mouse"==t.pointerType&&this.isDragging&&!this._panDisabled){this._debugMode?this.canvas.style.cursor="none":this.canvas.style.cursor="grabbing";const e={x:t.clientX,y:t.clientY};let i=r.subVector(this.dragStartPoint,e);this._alignCoordinateSystem||(i=r.flipYAxis(i));let a=r.rotatePoint(i,this._camera.rotation);a=r.multiplyVectorByScalar(a,1/this._camera.zoomLevel),this.inputObserver.notifyOnPan(this._camera,a),this.dragStartPoint=e}}scrollHandler(t){if(this._disabled)return;t.preventDefault();const e=t.deltaY*this.SCROLL_SENSATIVITY;if(t.ctrlKey){if(this._zoomDisabled)return;const i={x:t.clientX,y:t.clientY};let a=r.subVector(i,{x:this.canvas.getBoundingClientRect().left,y:this.canvas.getBoundingClientRect().top});this._alignCoordinateSystem||(a=r.subVector(i,{x:this.canvas.getBoundingClientRect().left,y:this.canvas.getBoundingClientRect().bottom}),a=r.flipYAxis(a)),this.inputObserver.notifyOnZoom(this._camera,-this._camera.zoomLevel*e*5,a)}else{if(this._panDisabled)return;let e={x:t.deltaX,y:t.deltaY};this._alignCoordinateSystem||(e=r.flipYAxis(e));let i=r.rotatePoint(e,this._camera.rotation);i=r.multiplyVectorByScalar(i,1/this._camera.zoomLevel),this.inputObserver.notifyOnPan(this._camera,i)}}keypressHandler(t){this._keyController.has(t.key)&&0==this._keyController.get(t.key)&&(t.preventDefault(),this._keyController.set(t.key,!0))}keyupHandler(t){this._keyController.has(t.key)&&1==this._keyController.get(t.key)&&(t.preventDefault(),this._keyController.set(t.key,!1),this.isDragging=!1,this.canvas.style.cursor="auto")}updateCamera(t){this._camera=t}get disabled(){return this._disabled}}class V{constructor(t,e,r,i=!0){this._panDisabled=!1,this._zoomDisabled=!1,this._rotateDisabled=!1,this.isDragging=!1,this.ZOOM_SENSATIVITY=.005,this.panInputCallBackList=[],this.zoomInputCallBackList=[],this.controlCamera=e,this.canvas=t,this._disabled=!1,this.touchPoints=[],this.zoomStartDist=0,this.isDragging=!1,this.dragStartPoint={x:0,y:0},this._alignCoordinateSystem=i,this.inputObserver=r,this.bindListeners()}bindListeners(){this.touchstartHandler=this.touchstartHandler.bind(this),this.touchendHandler=this.touchendHandler.bind(this),this.touchcancelHandler=this.touchcancelHandler.bind(this),this.touchmoveHandler=this.touchmoveHandler.bind(this)}resetAttributes(){this.touchPoints=[],this.zoomStartDist=0,this.isDragging=!1,this.dragStartPoint=null,this.tapPoint=null}enableStrategy(){this._disabled=!1}disableStrategy(){this.resetAttributes(),this._disabled=!0}setUp(){this.canvas.addEventListener("touchstart",this.touchstartHandler),this.canvas.addEventListener("touchend",this.touchendHandler),this.canvas.addEventListener("touchcancel",this.touchcancelHandler),this.canvas.addEventListener("touchmove",this.touchmoveHandler)}tearDown(){this.resetAttributes(),this.canvas.removeEventListener("touchstart",this.touchstartHandler),this.canvas.removeEventListener("touchend",this.touchendHandler),this.canvas.removeEventListener("touchcancel",this.touchcancelHandler),this.canvas.removeEventListener("touchmove",this.touchmoveHandler)}get disabled(){return this._disabled}get alignCoordinateSystem(){return this._alignCoordinateSystem}set alignCoordinateSystem(t){this._alignCoordinateSystem=t}get panDisabled(){return this._panDisabled}set panDisabled(t){this._panDisabled=t}get zoomDisabled(){return this._zoomDisabled}set zoomDisabled(t){this._zoomDisabled=t}get rotateDisabled(){return this._rotateDisabled}set rotateDisabled(t){this._rotateDisabled=t}get camera(){return this.controlCamera}set camera(t){this.controlCamera=t}updateCamera(t){this.controlCamera=t}touchstartHandler(t){if(!this._disabled)if(t.preventDefault(),2===t.targetTouches.length){this.isDragging=!1;let e={x:t.targetTouches[0].clientX,y:t.targetTouches[0].clientY},i={x:t.targetTouches[1].clientX,y:t.targetTouches[1].clientY};this.zoomStartDist=r.distanceBetweenPoints(e,i),this.touchPoints=[e,i]}else 1===t.targetTouches.length&&(this.tapPoint={x:t.targetTouches[0].clientX,y:t.targetTouches[0].clientY},this.tapPoint=this.controlCamera.convertFromViewPort2WorldSpace(this.convertWindowPoint2ViewPortPoint({x:this.canvas.getBoundingClientRect().left,y:this.canvas.getBoundingClientRect().top},this.tapPoint)),this.isDragging=!0,this.dragStartPoint={x:t.targetTouches[0].clientX,y:t.targetTouches[0].clientY})}touchcancelHandler(t){this._disabled||(this.isDragging=!1,this.touchPoints=[])}touchendHandler(t){this._disabled||(this.isDragging=!1,this.touchPoints=[])}touchmoveHandler(t){if(!this._disabled)if(t.preventDefault(),2==t.targetTouches.length&&2==this.touchPoints.length){if(this._zoomDisabled)return;let e={x:t.targetTouches[0].clientX,y:t.targetTouches[0].clientY},i={x:t.targetTouches[1].clientX,y:t.targetTouches[1].clientY},a=r.distanceBetweenPoints(e,i),o=this.zoomStartDist-a,s=r.linearInterpolation(e,i,.5);s=this._alignCoordinateSystem?this.convertWindowPoint2ViewPortPoint({x:this.canvas.getBoundingClientRect().left,y:this.canvas.getBoundingClientRect().top},s):this.convertWindowPoint2ViewPortPoint({x:this.canvas.getBoundingClientRect().left,y:this.canvas.getBoundingClientRect().bottom},s);let n=.1*o*this.controlCamera.zoomLevel*this.ZOOM_SENSATIVITY;this.inputObserver.notifyOnZoom(this.controlCamera,-n,s),this.touchPoints=[e,i],this.tapPoint=null}else if(1==t.targetTouches.length&&this.isDragging&&!this._panDisabled){let e={x:t.targetTouches[0].clientX,y:t.targetTouches[0].clientY},i=r.subVector(this.dragStartPoint,e);this._alignCoordinateSystem||(i=r.flipYAxis(i));let a=r.rotatePoint(i,this.controlCamera.rotation);a=r.multiplyVectorByScalar(a,1/this.controlCamera.zoomLevel),this.inputObserver.notifyOnPan(this.controlCamera,a),this.dragStartPoint=e,this.tapPoint=null}}convertWindowPoint2ViewPortPoint(t,e){const i=r.subVector(e,t);return this._alignCoordinateSystem?{x:i.x,y:i.y}:{x:i.x,y:-i.y}}}function M(t,e){return null!=e&&(null==t||e!=1/0&&void 0!==t&&(null==t.min||e>t.min))}function R(t,e,r,i){const a=n(t);if(null==a)return;const o=Math.abs(a*Math.cos(i)),s=Math.abs(a*Math.sin(i));return e/o==1/0?r/s:Math.max(e/o,r/s)}function D(t,e,r,i){const a=l(t);if(null==a)return;const o=e/Math.abs(a*Math.cos(i)),s=r/Math.abs(a*Math.sin(i));return s==1/0?o:Math.max(o,s)}class E{constructor(t){this.cameraSubscribers=[],this.panHandlerSubscribers=[],this.zoomHandlerSubscribers=[],this.rotationHandlerSubscribers=[],this._camera=t}subscribeToCamera(t){this.cameraSubscribers.push(t)}unsubscribeToCamera(t){this.cameraSubscribers=this.cameraSubscribers.filter((e=>e!==t))}subscribeToPanHandler(t){this.panHandlerSubscribers.push(t)}unsubscribeToPanHandler(t){this.panHandlerSubscribers=this.panHandlerSubscribers.filter((e=>e!==t))}subscribeToZoomHandler(t){this.zoomHandlerSubscribers.push(t)}unsubscribeToZoomHandler(t){this.zoomHandlerSubscribers=this.zoomHandlerSubscribers.filter((e=>e!==t))}subscribeToRotationHandler(t){return this.rotationHandlerSubscribers.push(t),()=>{this.rotationHandlerSubscribers=this.rotationHandlerSubscribers.filter((e=>e!==t))}}get camera(){return this._camera}set camera(t){this._camera=t,this.notifyCameraChange()}get panHandler(){return this._panHandler}set panHandler(t){this._panHandler=t,this.notifyPanHandlerChange()}get zoomHandler(){return this._zoomHandler}set zoomHandler(t){this._zoomHandler=t,this.notifyZoomHandlerChange()}get rotationHandler(){return this._rotationHandler}set rotationHandler(t){this._rotationHandler=t,this.notifyRotationHandlerChange()}notifyCameraChange(){this.cameraSubscribers.forEach((t=>t.updateCamera(this._camera)))}notifyPanHandlerChange(){this.panHandlerSubscribers.forEach((t=>t.updatePanHandler(this._panHandler)))}notifyZoomHandlerChange(){this.zoomHandlerSubscribers.forEach((t=>t.updateZoomHandler(this._zoomHandler)))}notifyRotationHandlerChange(){this.rotationHandlerSubscribers.forEach((t=>t.updateRotationHandler(this._rotationHandler)))}}class I{constructor(t){this.panCallbackList=[],this.zoomCallbackList=[],this.rotateCallbackList=[],this._controlCenter=t}notifyOnPan(t,e){this._controlCenter.notifyPanInput(t,e),this.panCallbackList.forEach((t=>{queueMicrotask((()=>{t({diff:e})}))}))}notifyOnZoom(t,e,r){this._controlCenter.notifyZoomInput(t,e,r),this.zoomCallbackList.forEach((t=>{queueMicrotask((()=>{t({deltaZoomAmount:e,anchorPoint:r})}))}))}notifyOnRotation(t,e){this._controlCenter.notifyRotationInput(t,e),this.rotateCallbackList.forEach((t=>{queueMicrotask((()=>{t({deltaRotation:e})}))}))}onInput(t,e){switch(t){case"pan":return this.panCallbackList.push(e),()=>{this.panCallbackList=this.panCallbackList.filter((t=>t!==e))};case"zoom":return this.zoomCallbackList.push(e),()=>{this.zoomCallbackList=this.zoomCallbackList.filter((t=>t!==e))};case"rotate":return this.rotateCallbackList.push(e),()=>{this.rotateCallbackList=this.rotateCallbackList.filter((t=>t!==e))};default:throw new Error("Invalid input event name")}}get controlCenter(){return this._controlCenter}set controlCenter(t){this._controlCenter=t}}class Y{constructor(t,e,r){this._panController=t,this._zoomController=e,this._rotationController=r}get panController(){return this._panController}get zoomController(){return this._zoomController}get rotationController(){return this._rotationController}notifyPanInput(t,e){this._panController.panCameraBy(t,e)}notifyZoomInput(t,e,r){this._zoomController.zoomCameraToAt(t,t.zoomLevel+e,r)}notifyRotationInput(t,e){this._rotationController.rotateCameraBy(t,e)}}let W=document.getElementById("test-graph"),Z=new class{constructor(t){this._alignCoordinateSystem=!0,this._fullScreen=!1,this.lastUpdateTime=0,this._canvas=t,this.boardStateObserver=new E(new O),this.boardStateObserver.camera.viewPortHeight=t.height,this.boardStateObserver.camera.viewPortWidth=t.width,this.boardStateObserver.camera.boundaries={min:{x:-5e3,y:-5e3},max:{x:5e3,y:5e3}};let e=t.getContext("2d");if(null==e)throw new Error("Canvas 2d context is null");this._context=e;let r=new g,i=new T(r),a=new H;this.bindFunctions(),this.attributeObserver=new MutationObserver(this.attributeCallBack),this.attributeObserver.observe(this._canvas,{attributes:!0}),this.windowResizeObserver=new ResizeObserver(this.windowResizeHandler),this.windowResizeObserver.observe(document.body),this.boardInputObserver=new I(new Y(r,i,a)),this._kmtStrategy=new k(this._canvas,this.boardStateObserver.camera,this.boardInputObserver),this.boardStateObserver.subscribeToCamera(this._kmtStrategy),this._touchStrategy=new V(this._canvas,this.boardStateObserver.camera,this.boardInputObserver),this.boardStateObserver.subscribeToCamera(this._touchStrategy),this.registerEventListeners()}registerEventListeners(){this._kmtStrategy.setUp(),this._touchStrategy.setUp()}removeEventListeners(){this._touchStrategy.tearDown(),this._kmtStrategy.tearDown()}setup(){this.registerEventListeners(),this.windowResizeObserver.observe(document.body),this.attributeObserver.observe(this._canvas,{attributes:!0})}tearDown(){this.removeEventListeners(),this.windowResizeObserver.disconnect(),this.attributeObserver.disconnect()}bindFunctions(){this.step=this.step.bind(this),this.attributeCallBack=this.attributeCallBack.bind(this),this.windowResizeHandler=this.windowResizeHandler.bind(this)}set width(t){if(this._canvas.width=t,this.boardStateObserver.camera.viewPortWidth=t,this.boardInputObserver.controlCenter.panController.limitEntireViewPort){const t=R(this.boardStateObserver.camera.boundaries,this._canvas.width,this._canvas.height,this.boardStateObserver.camera.rotation);null!=t&&M(this.boardStateObserver.camera.zoomBoundaries,t)&&this.boardStateObserver.camera.setMinZoomLevel(t)}}get width(){return this._canvas.width}set height(t){if(this._canvas.height=t,this.boardStateObserver.camera.viewPortHeight=t,this.boardInputObserver.controlCenter.panController.limitEntireViewPort){const t=D(this.boardStateObserver.camera.boundaries,this._canvas.width,this._canvas.height,this.boardStateObserver.camera.rotation);null!=t&&M(this.boardStateObserver.camera.zoomBoundaries,t)&&this.boardStateObserver.camera.setMinZoomLevel(t)}}get height(){return this._canvas.height}set alignCoordinateSystem(t){this._alignCoordinateSystem=t,this._kmtStrategy.alignCoordinateSystem=t,this._touchStrategy.alignCoordinateSystem=t}get alignCoordinateSystem(){return this._alignCoordinateSystem}get fullScreen(){return this._fullScreen}set fullScreen(t){this._fullScreen=t,this._fullScreen&&(this.width=window.innerWidth,this.height=window.innerHeight)}get context(){return this._context}set limitEntireViewPort(t){if(this.boardInputObserver.controlCenter.panController.limitEntireViewPort=t,t){const t=function(t,e,r,i){const a=n(t),o=l(t);if(null==a||null==o)return;let s=e/Math.abs(a*Math.cos(i)),h=e/Math.abs(o*Math.cos(i)),c=r/Math.abs(a*Math.sin(i)),d=r/Math.abs(o*Math.sin(i));s==1/0&&(s=0),h==1/0&&(h=0),c==1/0&&(c=0),d==1/0&&(d=0);const u=r/o,m=e/a;return Math.max(u,m,s,h,c,d)}(this.boardStateObserver.camera.boundaries,this._canvas.width,this._canvas.height,this.boardStateObserver.camera.rotation);null!=t&&M(this.boardStateObserver.camera.zoomBoundaries,t)&&this.boardStateObserver.camera.setMinZoomLevel(t)}}get limitEntireViewPort(){return this.boardInputObserver.controlCenter.panController.limitEntireViewPort}set kmtStrategy(t){this._kmtStrategy.tearDown(),this.boardStateObserver.unsubscribeToCamera(this._kmtStrategy),t.setUp(),this._kmtStrategy=t,this.boardStateObserver.subscribeToCamera(this._kmtStrategy),this._kmtStrategy.camera=this.boardStateObserver.camera}get kmtStrategy(){return this._kmtStrategy}set touchStrategy(t){this._touchStrategy.tearDown(),this.boardStateObserver.unsubscribeToCamera(this._touchStrategy),t.setUp(),this._touchStrategy=t,this.boardStateObserver.subscribeToCamera(this._touchStrategy),this._touchStrategy.camera=this.boardStateObserver.camera}get touchStrategy(){return this._touchStrategy}get camera(){return this.boardStateObserver.camera}set camera(t){t.viewPortHeight=this._canvas.height,t.viewPortWidth=this._canvas.width,this.boardStateObserver.camera=t}set panHandler(t){this.boardInputObserver.controlCenter.panController=t}get panHandler(){return this.boardInputObserver.controlCenter.panController}set zoomHandler(t){this.boardStateObserver.zoomHandler=t}get zoomHandler(){return this.boardStateObserver.zoomHandler}set controlCenter(t){let e=this.boardInputObserver.controlCenter.panController,r=this.boardInputObserver.controlCenter.zoomController,i=this.boardInputObserver.controlCenter.rotationController;t.panController=e,t.zoomController=r,t.rotationController=i,this.boardInputObserver.controlCenter=t}get controlCenter(){return this.boardInputObserver.controlCenter}step(t){this.lastUpdateTime,this.lastUpdateTime=t,this._context.reset();const e=this.boardStateObserver.camera.boundaries;if(null==(r=e)||null==r.max||null==r.min||null==r.max.x||null==r.max.y||null==r.min.x||null==r.min.y)throw new Error("Boundaries are not fully defined; not able to clear the canvas under the current implementation");var r;this._context.clearRect(e.min.x,-e.min.y,e.max.x-e.min.x,-(e.max.y-e.min.y)),this._context.translate(this._canvas.width/2,this._canvas.height/2),this._context.scale(this.boardStateObserver.camera.zoomLevel,this.boardStateObserver.camera.zoomLevel),this._alignCoordinateSystem?(this._context.rotate(-this.boardStateObserver.camera.rotation),this._context.translate(-this.boardStateObserver.camera.position.x,-this.boardStateObserver.camera.position.y)):(this._context.rotate(this.boardStateObserver.camera.rotation),this._context.translate(-this.boardStateObserver.camera.position.x,this.boardStateObserver.camera.position.y))}convertWindowPoint2ViewPortPoint(t,e){const i=r.subVector(e,t);return this._alignCoordinateSystem?{x:i.x,y:i.y}:{x:i.x,y:-i.y}}convertWindowPoint2WorldCoord(t){if(this._alignCoordinateSystem){const e=this.convertWindowPoint2ViewPortPoint({y:this._canvas.getBoundingClientRect().top,x:this._canvas.getBoundingClientRect().left},t);return this.boardStateObserver.camera.convertFromViewPort2WorldSpace(e)}{const e=this.convertWindowPoint2ViewPortPoint({y:this._canvas.getBoundingClientRect().bottom,x:this._canvas.getBoundingClientRect().left},t);return this.boardStateObserver.camera.convertFromViewPort2WorldSpace(e)}}on(t,e){return this.boardStateObserver.camera.on(t,e)}onInput(t,e){return this.boardInputObserver.onInput(t,e)}get maxHalfTransHeight(){return function(t){const e=l(t);return null!=e?e/2:void 0}(this.boardStateObserver.camera.boundaries)}get maxHalfTransWidth(){return function(t){const e=n(t);return null!=e?e/2:void 0}(this.boardStateObserver.camera.boundaries)}attributeCallBack(t,e){for(let e of t)if("attributes"===e.type)if("width"===e.attributeName){if(this.boardStateObserver.camera.viewPortWidth=this._canvas.width,this.limitEntireViewPort){const t=R(this.boardStateObserver.camera.boundaries,this._canvas.width,this._canvas.height,this.boardStateObserver.camera.rotation);M(this.boardStateObserver.camera.zoomBoundaries,t)&&this.boardStateObserver.camera.setMinZoomLevel(t)}}else if("height"===e.attributeName&&(this.boardStateObserver.camera.viewPortHeight=this._canvas.height,this.limitEntireViewPort)){const t=D(this.boardStateObserver.camera.boundaries,this._canvas.width,this._canvas.height,this.boardStateObserver.camera.rotation);M(this.boardStateObserver.camera.zoomBoundaries,t)&&this.boardStateObserver.camera.setMinZoomLevel(t)}}windowResizeHandler(){this._fullScreen&&(this.width=window.innerWidth,this.height=window.innerHeight)}setMaxTransWidthAlignedMin(t){const e=this.boardStateObserver.camera.boundaries,r=null==e?void 0:e.min,i=null==r?void 0:r.x;if(null==i?this.boardStateObserver.camera.setHorizontalBoundaries(-t,t):this.boardStateObserver.camera.setHorizontalBoundaries(i,i+2*t),this.limitEntireViewPort){const t=R(this.boardStateObserver.camera.boundaries,this._canvas.width,this._canvas.height,this.boardStateObserver.camera.rotation);M(this.boardStateObserver.camera.zoomBoundaries,t)&&this.boardStateObserver.camera.setMinZoomLevel(t)}}}(W);Z.fullScreen=!0;let A=document.querySelector("#start-recording"),X=document.querySelector("#clear-canvas-button"),U=!1,F=0,q=0,N=[],j=[];A&&(A.onclick=()=>{U&&console.log("recorder path",j),F=q,j=[],U=!U}),X&&(X.onclick=()=>{N=[]});let K,$=!1,G=0;W.addEventListener("touchstart",(t=>{$=!0,K=Z.convertWindowPoint2WorldCoord({x:t.targetTouches[0].clientX,y:t.targetTouches[0].clientY})})),W.addEventListener("touchend",(t=>{$=!1})),W.addEventListener("touchcancel",(t=>{$=!1})),W.addEventListener("touchmove",(t=>{if(1==t.targetTouches.length&&$){let e=Z.convertWindowPoint2WorldCoord({x:t.targetTouches[0].clientX,y:t.targetTouches[0].clientY});N.push({startPoint:Object.assign({},K),endPoint:Object.assign({},e),strokeStyle:`hsl(${G}, 60%, 60%)`,timePercentage:0}),U&&j.push({startPoint:Object.assign({},K),endPoint:Object.assign({},e),strokeStyle:`hsl(${G}, 60%, 60%)`,timePercentage:q-F}),K=e,G=(G+1)%360}}));const J=Z.context;window.requestAnimationFrame((function t(e){Z.step(e),q=e,N.forEach((t=>{J.strokeStyle=t.strokeStyle,J.beginPath(),J.moveTo(t.startPoint.x,-t.startPoint.y),J.lineTo(t.endPoint.x,-t.endPoint.y),J.stroke()})),window.requestAnimationFrame(t)}))})();
//# sourceMappingURL=index.js.map